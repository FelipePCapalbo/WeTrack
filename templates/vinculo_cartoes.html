{% extends "base.html" %}
{% block title %}Vínculo de Cartões{% endblock %}
{% block content %}
<div class="row-container">
  <!-- Formulário para vincular cartão -->
  <div class="vinculo-container">
    <h2>Vincular Cartão</h2>
    <form id="formVinculo" action="{{ url_for('vinculo_cartoes') }}" method="POST">
      <label for="cpf_usuario">Usuário</label>
      <select id="cpf_usuario" name="cpf_usuario" required>
        {% if usuarios_sem_vinculo %}
          {% for usuario in usuarios_sem_vinculo %}
            <option value="{{ usuario[0] }}">{{ usuario[1] }} - CPF: {{ usuario[0] }}</option>
          {% endfor %}
        {% else %}
          <option value="" disabled>Nenhum usuário disponível</option>
        {% endif %}
      </select>
      <label for="novo_id">Novo ID</label>
      <input type="text" id="novo_id" name="novo_id" required>
      <button type="submit">Vincular ID</button>
    </form>

    <!-- Exibição do status -->
    <div id="statusVersao" style="margin-top:10px; font-size:14px; color:#555;">
      Última atualização do banco: <span id="timestampStatus">carregando...</span>
    </div>
  </div>
  
  <!-- Tabela de usuários com cartões vinculados -->
  <div class="usuarios-vinculados-container">
    <h2>Usuários com Cartões Vinculados</h2>
    <table>
      <thead>
        <tr>
          <th>
            <a href="{{ url_for('vinculo_cartoes', sort='cpf', order=new_order, page=page) }}">
              CPF
              {% if sort == 'cpf' %}
                <span class="sort-icon">{{ '▲' if order=='asc' else '▼' }}</span>
              {% endif %}
            </a>
          </th>
          <th>
            <a href="{{ url_for('vinculo_cartoes', sort='nome', order=new_order, page=page) }}">
              Nome
              {% if sort == 'nome' %}
                <span class="sort-icon">{{ '▲' if order=='asc' else '▼' }}</span>
              {% endif %}
            </a>
          </th>
          <th>Cartões</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        {% for usuario in usuarios_com_vinculo %}
        <tr>
          <td>{{ usuario[0] }}</td>
          <td>{{ usuario[1] }}</td>
          <td>
            {% if usuario[2] %}
              {% for cartao in usuario[2] %}
                {{ cartao }}<br>
              {% endfor %}
            {% else %}
              <em>Sem cartões</em>
            {% endif %}
          </td>
          <td class="td-actions">
            {% if usuario[2] %}
              {% for cartao in usuario[2] %}
                <form style="margin-bottom:6px" action="{{ url_for('remover_vinculo', cpf=usuario[0], id_cartao=cartao) }}" method="POST" onsubmit="return confirm('Tem certeza que deseja remover o vínculo?');">
                  <button type="submit" class="btn-icon" title="Remover {{ cartao }}" aria-label="Remover {{ cartao }}">×</button>
                </form>
              {% else %}
                <em>Sem ações</em>
              {% endfor %}
            {% else %}
              <em>Sem ações</em>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="pagination">
      {% if page > 1 %}
        <a href="{{ url_for('vinculo_cartoes', sort=sort, order=order, page=page-1) }}">Anterior</a>
      {% endif %}
      <span>Página {{ page }}</span>
      {% if has_next %}
        <a href="{{ url_for('vinculo_cartoes', sort=sort, order=order, page=page+1) }}">Próxima</a>
      {% endif %}
    </div>
  </div>
</div>

<!-- ==================== SCRIPT JS ==================== -->
<script>
async function atualizarStatusBanco() {
  try {
    const response = await fetch('/api/status');
    const data = await response.json();
    const campo = document.getElementById('timestampStatus');
    if (data.usuarios_ultima_atualizacao) {
      const ts = new Date(data.usuarios_ultima_atualizacao);
      campo.textContent = ts.toLocaleString('pt-BR');
    } else {
      campo.textContent = "erro ao obter status";
    }
  } catch (err) {
    document.getElementById('timestampStatus').textContent = "erro na requisição";
    console.error("Erro ao consultar /api/status:", err);
  }
}

// Atualiza status assim que a página carregar
document.addEventListener("DOMContentLoaded", atualizarStatusBanco);

// Quando enviar o formulário de vínculo, atualiza o status depois de enviar
document.getElementById("formVinculo").addEventListener("submit", function() {
  // Espera 3 segundos (tempo para o backend processar e atualizar o banco)
  setTimeout(atualizarStatusBanco, 3000);
});
</script>
{% endblock %}
